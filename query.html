<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8"/>
  <meta name="viewport" content="width=device-width,initial-scale=1"/>
  <title>æˆ‘çš„ä¸­çç´€éŒ„</title>
  <style>
    body{margin:0;background:#111;color:#fff;font-family:"Microsoft JhengHei";padding:16px}
    h2{text-align:center;color:#ffd700;margin-bottom:16px}
    .loading,.error{text-align:center;margin:20px 0;color:#ccc}
    .card{background:#333;padding:12px;margin:12px 0;border-radius:8px}
    .card h3{margin:0 0 8px;color:#fff}
    .info{font-size:.9em;line-height:1.4}
    .expiry-date{color:#ff5555;font-weight:bold}
    .redeemBtn{width:100%;padding:10px;margin-top:8px;border:none;border-radius:6px;
      background:#ffc107;color:#000;font-size:1em;cursor:pointer;}
    .redeemBtn.done{background:#666;color:#bbb;cursor:not-allowed;}
    .redeemBtn.expired{background:#dc3545;color:#fff;cursor:not-allowed;}
    .redeemBtn.loading{background:#007bff;color:#fff;cursor:wait;}
    .back{position:fixed;top:12px;left:12px;background:#007bff;color:#fff;
      border:none;padding:8px 12px;border-radius:5px;}
    .spinner{border:2px solid #f3f3f3;border-top:2px solid #3498db;border-radius:50%;
      width:20px;height:20px;animation:spin 1s linear infinite;display:inline-block;
      margin-right:8px;}
    @keyframes spin{0%{transform:rotate(0deg)}100%{transform:rotate(360deg)}}
    .notification{position:fixed;top:20px;right:20px;padding:15px 20px;border-radius:8px;
      color:#fff;font-weight:bold;z-index:1000;transform:translateX(400px);
      transition:transform 0.3s ease;}
    .notification.show{transform:translateX(0)}
    .notification.success{background:#27ae60}
    .notification.error{background:#e74c3c}
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <button class="back" onclick="history.back()">â† è¿”å›</button>
  <h2>ğŸ æˆ‘çš„ä¸­çç´€éŒ„</h2>
  <div id="list"><div class="loading">è¼‰å…¥ä¸­â€¦</div></div>
  <script>
    const LIFF_ID = '165687155-XXXXXXX'; // æ›æˆä½ çš„
    const API = 'https://script.google.com/macros/s/ä½ çš„ExecID/exec';
    async function init(){
      await liff.init({liffId:LIFF_ID});
      let uid = liff.isLoggedIn()? (await liff.getProfile()).userId : prompt('è«‹è¼¸å…¥LINE ID');
      if(!uid) return document.getElementById('list').innerHTML='<div class="error">ç„¡æ³•å–å¾—ID</div>';
      loadRecords(uid);
    }
    async function loadRecords(uid){
      const list=document.getElementById('list');
      list.innerHTML='<div class="loading"><div class="spinner"></div>è¼‰å…¥ä¸­â€¦</div>';
      try{
        const res=await fetch(`${API}?act=query&userId=${encodeURIComponent(uid)}`);
        if(!res.ok) throw new Error(`HTTP${res.status}`);
        const j=await res.json(); if(!j.ok) throw new Error(j.msg||'å¾Œç«¯éŒ¯èª¤');
        render(j.records);
      }catch(e){
        list.innerHTML=`<div class="error">è®€å–å¤±æ•—ï¼š${e.message}</div>`;
      }
    }
    function render(arr){
      const list=document.getElementById('list');
      if(!arr.length) return list.innerHTML='<p class="loading">å°šç„¡ä¸­çç´€éŒ„</p>';
      const now=new Date();
      list.innerHTML=arr.map(o=>{
        let isExpired=false,expDisp='ç„¡éæœŸæ™‚é–“';
        if(o.expiryTime){
          const d=new Date(o.expiryTime);
          if(!isNaN(d)) {expDisp=d.toISOString().slice(0,10); if(d<now) isExpired=true;}
          else expDisp='æ—¥æœŸéŒ¯èª¤';
        }
        let btnHtml;
        if(o.redeemed==='æ˜¯')      btnHtml=`<button class="redeemBtn done" disabled>å·²æ ¸éŠ·<br>${o.redeemTime}</button>`;
        else if(isExpired)         btnHtml=`<button class="redeemBtn expired" disabled>å·²éæœŸ</button>`;
        else                       btnHtml=`<button class="redeemBtn" onclick="redeem(${o.recordId},this)">æ ¸éŠ·</button>`;
        return `<div class="card" id="c${o.recordId}">
          <h3>${o.prize}</h3>
          <div class="info">
            åº—å®¶åç¨±ï¼š${o.storeName}<br>
            ä¸­çæ™‚é–“ï¼š${o.winTime}<br>
            éæœŸæ™‚é–“ï¼š<span class="expiry-date">${expDisp}</span><br>
            æ ¸éŠ·ç‹€æ…‹ï¼š${o.redeemed==='æ˜¯'?'å·²æ ¸éŠ·':'æœªæ ¸éŠ·'}<br>
            ${o.redeemed==='æ˜¯'?`æ ¸éŠ·æ™‚é–“ï¼š${o.redeemTime}<br>`:''}
          </div>
          ${btnHtml}
        </div>`;
      }).join('');
    }
    async function redeem(recordId,btn){
      btn.disabled=true;btn.className='redeemBtn loading';btn.innerHTML='<div class="spinner"></div>è™•ç†ä¸­â€¦';
      try{
        await fetch(API,{
          method:'POST',mode:'no-cors',
          headers:{'Content-Type':'text/plain'},
          body:JSON.stringify({act:'redeem',recordId})
        });
        const nowStr=new Date().toLocaleString('zh-TW',{hour12:false}).replace(/\//g,'-');
        const card=btn.closest('.card'),info=card.querySelector('.info');
        info.innerHTML=info.innerHTML.replace(/æ ¸éŠ·ç‹€æ…‹ï¼šæœªæ ¸éŠ·/,'æ ¸éŠ·ç‹€æ…‹ï¼šå·²æ ¸éŠ·')+`æ ¸éŠ·æ™‚é–“ï¼š${nowStr}<br>`;
        btn.className='redeemBtn done';btn.innerHTML=`å·²æ ¸éŠ·<br>${nowStr}`;
      }catch(e){
        console.error(e);
        btn.disabled=false;btn.className='redeemBtn';btn.innerHTML='æ ¸éŠ·';
        showNotification('æ ¸éŠ·å¤±æ•—','error');
      }
    }
    function showNotification(msg,type='success'){
      const n=document.createElement('div');
      n.className=`notification ${type}`;n.textContent=msg;document.body.append(n);
      setTimeout(()=>n.classList.add('show'),100);
      setTimeout(()=>{n.classList.remove('show');setTimeout(()=>n.remove(),300);},3000);
    }
    init();
  </script>
</body>
</html>
