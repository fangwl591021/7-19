<!DOCTYPE html>
<html lang="zh-Hant">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>å¥½ç¦®å¤§æ–¹æŠ½</title>
  <style>
    body { background:#000; color:#fff; text-align:center; font-family:"Microsoft JhengHei" }
    h1 { color:gold; margin:24px 0 12px }
    .welcome { color:#90EE90; margin:16px 0; font-size:1.2em; font-weight:bold }
    #play, #submit { width:80%; max-width:320px; margin:12px auto; padding:14px 0;
      font-size:1.1em; border:none; border-radius:8px; display:block }
    #play { background:#28a745; color:#fff }
    #submit { background:#ffc107; color:#000; display:none }
    #wrapSubmit{display:flex; justify-content:center}
    video { width:100%; max-width:420px; border-radius:12px; display:none; margin-top:20px }
    input { width:80%; max-width:320px; padding:10px; margin:6px 0; border-radius:6px; border:none; font-size:1em }
    #msg { margin:18px 0 8px; font-size:1.4em; font-weight:bold }
    .error-msg { color:#ff6b6b; margin:18px 0 8px; font-size:1.2em; font-weight:bold }
    .info-msg { color:#87CEEB; margin:18px 0 8px; font-size:1.1em }
  </style>
  <script src="https://static.line-scdn.net/liff/edge/2/sdk.js"></script>
</head>
<body>
  <h1>ğŸ° è½‰è½‰å°ç‘ªè‰</h1>
  <div class="welcome" id="welcomeMsg">è¼‰å…¥ä¸­...</div>
  <button id="play" disabled>è¼‰å…¥ä¸­â€¦</button>
  
  <!-- é›™å½±ç‰‡æº -->
  <video id="mv" playsinline>
    <source id="videoSource" src="" type="video/mp4">
  </video>
  
  <div id="msg"></div>
  <div class="error-msg" id="errorMsg" style="display:none"></div>
  <div class="info-msg" id="infoMsg" style="display:none"></div>
  
  <div id="form" style="display:none">
    <input id="username" placeholder="å§“å" />
    <input id="phone" placeholder="æ‰‹æ©Ÿ" />
    <div id="wrapSubmit"><button id="submit">é€å‡º</button></div>
  </div>
  
  <audio id="winSound" preload="auto"
           src="https://aiwe.cc/wp-content/uploads/2025/07/56ab24c15b72a457069c5ea42fcfc640.mp3"></audio>
  <audio id="loseSound" preload="auto"
           src="https://aiwe.cc/wp-content/uploads/2025/07/b3a7a4e64bcd8aabe4cabe0e55b57af5.mp3"></audio>

<script>
// ğŸ”¥ è«‹æ›´æ–°ç‚ºæ‚¨çš„å¯¦éš›è¨­å®š
const LIFF_ID = "1656871455-A1lEEOaB"; 
const API = "https://script.google.com/macros/s/AKfycbzjcBDITCdIeYuRa5g8tLuXHNYtYBf9YLBXg4yUibsggAyKlIH7FzLE3qW7Q6m2u9rj/exec";

// é›™å½±ç‰‡æº
const VIDEO_SOURCES = [
  {
    url: "https://voom-obs.line-scdn.net/hlCRdDEcYL206cTxjDScoFBNJJEIQdnV_LAIXSjV7EgYpVB9hLCd0ChpvBhcjSzV8LDMXCyt7DQAXSHVzAw0bTyF7K18pSBQ7ADAMTDFBN1Q-XQ/mp4",
    duration: 7000, // 7ç§’å¾Œæš«åœ
    type: "timed"
  },
  {
    url: "https://voom-obs.line-scdn.net/hFQuN8s3SBX8dWxZxKg0CBjRjDlA3XF9tC1MiGDheIBMZTDltJw0TWRNFLAUEYR9uCxk9GQxRJxIwYl9hJCc-XhJoPE83XD4pCwomXhZrHUYZdw/mp4",
    duration: null, // æ’­æ”¾å®Œæ•´æ®µ
    type: "full"
  }
];

let uid="", uname="";
let currentVideoType = "";

const welcomeMsg = document.getElementById("welcomeMsg"),
      btnPlay = document.getElementById("play"),
      mv = document.getElementById("mv"),
      videoSource = document.getElementById("videoSource"),
      msg = document.getElementById("msg"),
      errorMsg = document.getElementById("errorMsg"),
      infoMsg = document.getElementById("infoMsg"),
      form = document.getElementById("form"),
      inName = document.getElementById("username"),
      inPhone = document.getElementById("phone"),
      btnSend = document.getElementById("submit"),
      winSound = document.getElementById("winSound"),
      loseSound = document.getElementById("loseSound");

// ç­‰å¾…é é¢è¼‰å…¥å®Œæˆ
window.addEventListener('load', function() {
  if (typeof liff === 'undefined') {
    console.error('LIFF SDK æœªè¼‰å…¥');
    welcomeMsg.textContent = "LIFF è¼‰å…¥å¤±æ•—";
    btnPlay.textContent = "ç³»çµ±éŒ¯èª¤";
    btnPlay.disabled = true;
    errorMsg.textContent = "è«‹åœ¨ LINE ä¸­é–‹å•Ÿæ­¤é é¢";
    errorMsg.style.display = "block";
    return;
  }
  initializeLiff();
});

async function initializeLiff() {
  try {
    console.log('é–‹å§‹ LIFF åˆå§‹åŒ–...');
    await liff.init({liffId: LIFF_ID});
    
    if(!liff.isLoggedIn()){ 
      console.log('ç”¨æˆ¶æœªç™»å…¥ï¼Œè·³è½‰åˆ°ç™»å…¥é é¢');
      liff.login(); 
      return; 
    }
    
    console.log('ç”¨æˆ¶å·²ç™»å…¥ï¼Œå–å¾—ç”¨æˆ¶è³‡æ–™');
    const profile = await liff.getProfile();
    uid = profile.userId;
    uname = profile.displayName;
    
    console.log('ç”¨æˆ¶è³‡æ–™:', { uid: uid, uname: uname });
    
    // ğŸ”¥ é¡¯ç¤ºæ­¡è¿è¨Šæ¯
    welcomeMsg.textContent = `Hi ${uname}ï¼Œæ­¡è¿ä¾†ç©è½‰è½‰å°ç‘ªè‰ï¼`;
    
    // ğŸ”¥ ç›´æ¥å…è¨±éŠæˆ²ï¼Œä¸åšä»»ä½•æª¢æŸ¥
    btnPlay.textContent = "é–‹å§‹éŠæˆ²";
    btnPlay.disabled = false;
    btnPlay.onclick = startGame;
    
  } catch (error) {
    console.error('LIFF åˆå§‹åŒ–å¤±æ•—:', error);
    welcomeMsg.textContent = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—";
    btnPlay.textContent = "ç³»çµ±éŒ¯èª¤";
    btnPlay.disabled = true;
    errorMsg.textContent = "ç³»çµ±åˆå§‹åŒ–å¤±æ•—ï¼Œè«‹é‡æ–°é–‹å•Ÿ";
    errorMsg.style.display = "block";
  }
}

// ğŸ”¥ é–‹å§‹éŠæˆ² - ä¸åšä»»ä½•æª¢æŸ¥
function startGame() {
  console.log('ğŸ® é–‹å§‹éŠæˆ² - ç„¡éœ€æª¢æŸ¥');
  
  if (!uid) {
    errorMsg.textContent = "ç”¨æˆ¶è³‡è¨ŠéŒ¯èª¤";
    errorMsg.style.display = "block";
    return;
  }
  
  // é‡ç½®æ‰€æœ‰è¨Šæ¯
  msg.textContent = "";
  errorMsg.style.display = "none";
  infoMsg.style.display = "none";
  
  // éš±è—æŒ‰éˆ•ï¼Œæº–å‚™æ’­æ”¾å½±ç‰‡
  btnPlay.style.display = "none";
  
  // ğŸ”¥ éš¨æ©Ÿé¸æ“‡å½±ç‰‡
  const selectedVideo = VIDEO_SOURCES[Math.floor(Math.random() * VIDEO_SOURCES.length)];
  currentVideoType = selectedVideo.type;
  
  console.log('é¸ä¸­çš„å½±ç‰‡:', selectedVideo);
  
  // è¨­å®šå½±ç‰‡æºä¸¦æ’­æ”¾
  videoSource.src = selectedVideo.url;
  mv.load();
  mv.style.display = "block";
  mv.currentTime = 0;
  
  // è¼‰å…¥éŸ³æ•ˆ
  winSound.load(); 
  loseSound.load();
  
  mv.play().then(() => {
    console.log('å½±ç‰‡é–‹å§‹æ’­æ”¾');
    
    // å¦‚æœæ˜¯å®šæ™‚å½±ç‰‡ï¼Œè¨­å®šæš«åœæ™‚é–“
    if (selectedVideo.duration) {
      setTimeout(() => {
        mv.pause();
        console.log('å®šæ™‚å½±ç‰‡æš«åœ');
      }, selectedVideo.duration);
    }
  }).catch(e => {
    console.error('å½±ç‰‡æ’­æ”¾å¤±æ•—:', e);
    msg.textContent = "å½±ç‰‡æ’­æ”¾å¤±æ•—";
  });
}

// ğŸ”¥ å½±ç‰‡çµæŸæˆ–æš«åœäº‹ä»¶
mv.onpause = mv.onended = async () => {
  console.log('å½±ç‰‡çµæŸï¼Œé–‹å§‹æŠ½çæµç¨‹');
  mv.style.display = "none";
  
  // ğŸ”¥ å…ˆæª¢æŸ¥ç”¨æˆ¶ä»Šæ—¥æ˜¯å¦å·²æœ‰è¨˜éŒ„
  const hasRecordToday = await checkUserTodayRecord(uid);
  
  let win = false;
  let shouldRecord = false;
  let resultMessage = "";
  
  if (hasRecordToday) {
    // ğŸ”¥ ä»Šæ—¥å·²æœ‰è¨˜éŒ„ï¼šç›´æ¥çµ¦ MISSï¼Œä¸å¯«å…¥æ–°è¨˜éŒ„
    console.log('ç”¨æˆ¶ä»Šæ—¥å·²æœ‰è¨˜éŒ„ï¼Œç›´æ¥çµ¦ MISS');
    win = false;
    shouldRecord = false;
    resultMessage = "æ‚¨ä»Šæ—¥å·²åƒåŠ éï¼Œæ˜æ—¥å†ä¾†è©¦æ‰‹æ°£å§ï¼";
    
    infoMsg.textContent = "ä»Šæ—¥å·²åƒåŠ ééŠæˆ²";
    infoMsg.style.display = "block";
    
  } else {
    // ğŸ”¥ ä»Šæ—¥ç„¡è¨˜éŒ„ï¼šä½¿ç”¨éš¨æ©Ÿæ±ºå®šï¼Œä¸¦å¯«å…¥è¨˜éŒ„
    console.log('ç”¨æˆ¶ä»Šæ—¥ç„¡è¨˜éŒ„ï¼Œé€²è¡Œæ­£å¸¸æŠ½ç');
    win = Math.random() < 0.25; // 25% æ©Ÿç‡ä¸­ç
    shouldRecord = true;
    resultMessage = win ? "ğŸŠ æ­å–œä¸­çï¼" : "ğŸ˜­ å†æ¥å†å²ï¼";
  }
  
  console.log('ğŸ² æœ€çµ‚çµæœ:', { win, shouldRecord, resultMessage });
  
  // ğŸ”¥ å¦‚æœéœ€è¦è¨˜éŒ„ï¼Œç™¼é€åˆ°å¾Œç«¯
  if (shouldRecord) {
    try {
      await recordLotteryResult(uid, uname, win ? "WIN" : "MISS");
    } catch (e) {
      console.error("è¨˜éŒ„å¤±æ•—:", e);
    }
  }
  
  // é¡¯ç¤ºçµæœ
  msg.textContent = resultMessage;
  
  if (win) {
    try { await winSound.play(); } catch(_) {}
    form.style.display = "block";
    inName.value = uname;
    btnSend.style.display = "block";
  } else {
    try { await loseSound.play(); } catch(_) {}
    setTimeout(() => {
      liff.closeWindow();
    }, 3000);
  }
};

// ğŸ”¥ æª¢æŸ¥ç”¨æˆ¶ä»Šæ—¥æ˜¯å¦å·²æœ‰è¨˜éŒ„
async function checkUserTodayRecord(userId) {
  console.log('æª¢æŸ¥ç”¨æˆ¶ä»Šæ—¥è¨˜éŒ„:', userId);
  
  try {
    const response = await fetch(`${API}?act=checkDaily&userId=${encodeURIComponent(userId)}`, {
      method: 'GET',
      mode: 'cors'
    });
    
    if (response.ok) {
      const result = await response.json();
      console.log('æª¢æŸ¥çµæœ:', result);
      
      // å¦‚æœ success ç‚º false ä¸”è¨Šæ¯åŒ…å«å·²ç©éï¼Œè¡¨ç¤ºä»Šæ—¥æœ‰è¨˜éŒ„
      if (result.success === false && result.msg && result.msg.includes('å·²ç©é')) {
        return true; // ä»Šæ—¥å·²æœ‰è¨˜éŒ„
      }
    }
    
    return false; // ä»Šæ—¥ç„¡è¨˜éŒ„
    
  } catch (error) {
    console.error('æª¢æŸ¥è¨˜éŒ„å¤±æ•—:', error);
    return false; // éŒ¯èª¤æ™‚å‡è¨­ç„¡è¨˜éŒ„ï¼Œå…è¨±æŠ½ç
  }
}

// ğŸ”¥ è¨˜éŒ„æŠ½ççµæœ
async function recordLotteryResult(userId, displayName, result) {
  console.log('è¨˜éŒ„æŠ½ççµæœ:', { userId, displayName, result });
  
  try {
    const response = await fetch(API, {
      method: "POST",
      mode: "no-cors",
      headers: { "Content-Type": "text/plain" },
      body: JSON.stringify({
        act: "draw",
        userId: userId,
        displayName: displayName,
        result: result
      })
    });
    
    console.log('âœ… æŠ½çè¨˜éŒ„å·²ç™¼é€');
    
  } catch (error) {
    console.error('âŒ è¨˜éŒ„å¤±æ•—:', error);
    throw error;
  }
}

// ä¸­çè³‡æ–™æäº¤
btnSend.onclick = () => {
  if(!inName.value.trim()){
    alert("è«‹å¡«å¯«å§“å");
    return;
  }
  if(!inPhone.value.trim()){
    alert("è«‹å¡«å¯«æ‰‹æ©Ÿè™Ÿç¢¼");
    return;
  }

  btnSend.disabled = true;
  btnSend.innerText = "é€å‡ºä¸­â€¦";
  btnSend.style.background = "#555";

  fetch(API, {
    method: "POST", 
    mode: "no-cors",
    headers: {"Content-Type": "text/plain"},
    body: JSON.stringify({
      act: "winner",
      userId: uid,
      displayName: uname,
      name: inName.value.trim(),
      phone: inPhone.value.trim()
    })
  }).then(() => {
    msg.textContent = "âœ… è³‡æ–™å·²é€å‡ºï¼æ„Ÿè¬æ‚¨çš„å¡«å¯«ï¼";
    btnSend.disabled = false;
    btnSend.style.background = "#fff";
    btnSend.style.color = "#000";
    btnSend.innerText = "é»å³ä¸Šè§’ X è¿”å›";
    btnSend.onclick = () => liff.closeWindow();
  }).catch((e) => {
    alert("é€å‡ºå¤±æ•—ï¼šç¶²è·¯å•é¡Œæˆ–ä¼ºæœå™¨éŒ¯èª¤ã€‚\n" + e.message);
    console.error("âŒ æäº¤è³‡æ–™å¤±æ•—:", e);
    btnSend.disabled = false;
    btnSend.innerText = "é‡æ–°é€å‡º";
    btnSend.style.background = "#ffc107";
  });
};
</script>
</body>
</html>
